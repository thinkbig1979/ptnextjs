# Production Docker Compose for Paul Thames Superyacht Technology
#
# ARCHITECTURE:
#   This compose file is designed to live OUTSIDE the git repository on your VPS.
#   The build context points to the git repository location.
#
#   VPS Directory Structure:
#     /home/pt/ptnextjs/              <- Git repository (PROJECT_DIR)
#     /home/dockge/stacks/ptnext-app/ <- This compose file (COMPOSE_DIR)
#       ├── docker-compose.yml
#       ├── .env.production
#       ├── media/                    <- Persistent media uploads
#       └── backups/                  <- Database backups
#     /var/lib/ptnextjs/postgres/     <- PostgreSQL data (POSTGRES_DATA_PATH)
#
# SETUP:
#   1. Create PostgreSQL data directory with correct permissions:
#      sudo mkdir -p /var/lib/ptnextjs/postgres
#      sudo chown -R 999:999 /var/lib/ptnextjs/postgres
#      sudo chmod 700 /var/lib/ptnextjs/postgres
#
#   2. Copy this file to your compose directory and rename:
#      cp docker-compose.production.example.yml /path/to/compose/docker-compose.yml
#
#   3. Copy and configure environment:
#      cp .env.production.example /path/to/compose/.env.production
#      # Edit .env.production with your values
#
#   4. Build and run:
#      docker compose --env-file .env.production build
#      docker compose --env-file .env.production up -d
#
# PROFILES:
#   - Default: postgres + app
#   - with-nginx: Add nginx reverse proxy (if not using external nginx)
#   - with-backup: Add daily PostgreSQL backups

services:
  postgres:
    image: postgres:16-alpine
    container_name: ptnextjs-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ${POSTGRES_DATA_PATH:-/var/lib/ptnextjs/postgres}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ptnextjs-network

  app:
    build:
      context: ${PROJECT_DIR:-/home/pt/ptnextjs}
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SERVER_URL: ${NEXT_PUBLIC_SERVER_URL}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL}
        NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
        NEXT_PUBLIC_HCAPTCHA_SITE_KEY: ${NEXT_PUBLIC_HCAPTCHA_SITE_KEY}
        PAYLOAD_SECRET: ${PAYLOAD_SECRET}
    image: ptnextjs-app:latest
    container_name: ptnextjs-app
    restart: unless-stopped
    env_file: .env.production
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      USE_POSTGRES: "true"
      PAYLOAD_SECRET: ${PAYLOAD_SECRET}
      NEXT_PUBLIC_SERVER_URL: ${NEXT_PUBLIC_SERVER_URL}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
      RESEND_API_KEY: ${RESEND_API_KEY}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS}
      ADMIN_EMAIL_ADDRESS: ${ADMIN_EMAIL_ADDRESS}
      NEXT_PUBLIC_HCAPTCHA_SITE_KEY: ${NEXT_PUBLIC_HCAPTCHA_SITE_KEY}
      HCAPTCHA_SECRET_KEY: ${HCAPTCHA_SECRET_KEY}
    ports:
      - "${PORT:-3000}:3000"
    volumes:
      # Only mount persistent data - app code is baked into the image
      - ${MEDIA_PATH:-./media}:/app/public/media
    depends_on:
      postgres:
        condition: service_healthy
    # No command override - uses Dockerfile's CMD (docker-entrypoint.sh)
    networks:
      - ptnextjs-network
      - nginx

  nginx:
    image: nginx:alpine
    container_name: ptnextjs-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ${SSL_CERTS_PATH:-/etc/letsencrypt}:/etc/letsencrypt:ro
    depends_on:
      - app
    networks:
      - ptnextjs-network
    profiles:
      - with-nginx

  backup:
    image: postgres:16-alpine
    container_name: ptnextjs-backup
    restart: unless-stopped
    environment:
      PGHOST: postgres
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB}
    volumes:
      - ${BACKUP_PATH:-./backups}:/backups
    command: >
      sh -c "
        while true; do
          TIMESTAMP=$$(date +%Y%m%d_%H%M%S)
          pg_dump -Fc > /backups/ptnextjs_$$TIMESTAMP.dump
          find /backups -name '*.dump' -mtime +7 -delete
          echo \"Backup completed: ptnextjs_$$TIMESTAMP.dump\"
          sleep 86400
        done
      "
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ptnextjs-network
    profiles:
      - with-backup

networks:
  ptnextjs-network:
    driver: bridge
  nginx:
    external: true
