# Integration Requirements

This is the integration requirements for the spec detailed in @.agent-os/specs/2025-10-14-complete-tinacms-payload-migration/spec.md

## System Integration Overview

This migration integrates Payload CMS as the primary content management system, replacing TinaCMS throughout the application stack. Integration occurs at the data layer, with frontend consuming Payload REST API via PayloadCMSDataService.

## API Integration Requirements

### Payload CMS REST API

**Endpoint Structure**:
```
Base URL: http://localhost:3000/api (development)
          https://yourdomain.com/api (production)

Collections:
GET    /api/vendors                 - List all vendors
GET    /api/vendors/:id             - Get vendor by ID
GET    /api/vendors?where[slug][equals]=vendor-slug - Get by slug
POST   /api/vendors                 - Create vendor (admin only)
PATCH  /api/vendors/:id             - Update vendor
DELETE /api/vendors/:id             - Delete vendor (admin only)

GET    /api/products                - List all products
GET    /api/products/:id            - Get product by ID
GET    /api/products?where[vendor][equals]=:vendorId - Filter by vendor

GET    /api/yachts                  - List all yachts
GET    /api/yachts/:id              - Get yacht by ID

GET    /api/blog-posts              - List blog posts
GET    /api/blog-posts?where[published][equals]=true - Published only

GET    /api/categories              - List categories
GET    /api/tags                    - List tags
GET    /api/team-members            - List team members
GET    /api/company-info            - Get company info (singleton)
```

**Authentication**:
- Public read access (GET requests)
- Admin-only write access (POST, PATCH, DELETE)
- JWT-based authentication for vendor dashboard
- API key authentication for server-side requests

**Query Parameters**:
- `limit`: Number of results (default: 10, max: 100)
- `page`: Page number for pagination
- `depth`: Relationship depth (0-3, default: 1)
- `where`: Complex query filtering
- `sort`: Sort field and direction

**Example Queries**:
```typescript
// Get all published vendors with categories
const response = await fetch('/api/vendors?where[published][equals]=true&depth=2');

// Get products for specific vendor
const response = await fetch(`/api/products?where[vendor][equals]=${vendorId}&depth=3`);

// Get featured yachts with all relationships
const response = await fetch('/api/yachts?where[featured][equals]=true&depth=2');
```

### PayloadCMSDataService Integration

**Service Location**: `lib/payload-cms-data-service.ts`

**Integration Pattern**:
```typescript
// Application code uses service methods
import payloadCMSDataService from '@/lib/payload-cms-data-service';

// Service internally calls Payload API
const vendors = await payloadCMSDataService.getAllVendors();

// Service handles:
// - API requests to Payload
// - Response transformation
// - Caching (5-minute TTL)
// - Error handling
// - Type safety
```

**Caching Strategy**:
- In-memory cache with 5-minute TTL
- Cache key based on method + parameters
- Cache invalidation on updates (in vendor dashboard)
- Build-time caching for static generation

**Error Handling**:
- Graceful degradation on API failures
- Retry logic for transient errors
- Fallback to empty arrays/null for missing data
- Detailed error logging for debugging

## Database Integration

### PostgreSQL Production Integration

**Connection Configuration**:
```typescript
// payload.config.ts
db: postgresAdapter({
  pool: {
    connectionString: process.env.DATABASE_URL,
    max: 20, // Maximum connection pool size
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
  },
  migrationDir: path.resolve(__dirname, 'migrations'),
})
```

**Environment Variables**:
```bash
# Production PostgreSQL
DATABASE_URL=postgresql://user:password@host:5432/database

# Development SQLite
DATABASE_URL=file:./data/payload.db

# Payload Config
PAYLOAD_SECRET=your-secret-key-minimum-32-characters
NEXT_PUBLIC_SERVER_URL=https://yourdomain.com
```

**Connection Pooling**:
- Maximum 20 concurrent connections
- Idle timeout: 30 seconds
- Connection timeout: 2 seconds
- Automatic connection recycling

**Migration Management**:
- Migrations stored in `migrations/` directory
- Auto-generated by Payload when schema changes
- Version-controlled migrations for deployment
- Rollback support via migration history

### Database Compatibility

**SQLite (Development)**:
- Zero-configuration setup
- File-based database: `data/payload.db`
- Fast for local development
- No external database server required

**PostgreSQL (Production)**:
- Hosted PostgreSQL (AWS RDS, DigitalOcean, etc.)
- Persistent data storage
- Concurrent access support
- Advanced indexing and performance

**Payload Migration Functions**:
- Handles differences between SQLite and PostgreSQL
- Same Payload config works for both
- Automatic schema synchronization
- Data type compatibility layer

## External Service Integration

### Email Service (Future Enhancement)

**Purpose**: Vendor notifications, welcome emails, password resets

**Integration Options**:
- SendGrid
- Resend
- AWS SES

**Status**: Deferred to post-migration phase

### File Storage Integration

**Current**: Local file storage (`public/media/`)

**Media Path Handling**:
- TinaCMS media paths: `/media/filename.jpg`
- Payload media paths: `/media/filename.jpg`
- Transform function ensures compatibility
- Media files remain in `public/media/` directory

**Future Enhancement**:
- Cloud storage (AWS S3, Cloudflare R2)
- CDN integration for performance
- Image optimization service

## Frontend Integration

### Next.js App Router Integration

**Static Site Generation**:
```typescript
// app/vendors/[slug]/page.tsx
export async function generateStaticParams() {
  const slugs = await payloadCMSDataService.getVendorSlugs();
  return slugs.map(slug => ({ slug }));
}

export default async function Page({ params }: { params: { slug: string } }) {
  const vendor = await payloadCMSDataService.getVendorBySlug(params.slug);
  return <VendorDetailPage vendor={vendor} />;
}
```

**Build-Time Data Fetching**:
- All pages fetch data at build time
- No client-side data fetching for content
- Static HTML generation for performance
- Incremental Static Regeneration (ISR) possible

**Integration Points**:
1. **Vendor Pages**: `app/vendors/**` → PayloadCMSDataService
2. **Product Pages**: `app/products/**` → PayloadCMSDataService
3. **Yacht Pages**: `app/yachts/**` → PayloadCMSDataService (new)
4. **Blog Pages**: `app/blog/**` → PayloadCMSDataService
5. **Team Page**: `app/team/page.tsx` → PayloadCMSDataService
6. **Company Pages**: `app/about/page.tsx` → PayloadCMSDataService
7. **Homepage**: `app/page.tsx` → PayloadCMSDataService (featured content)

### Component Integration

**Data Flow**:
```
Payload Database
  ↓ (REST API)
PayloadCMSDataService
  ↓ (transform to app types)
Page Components (Server Components)
  ↓ (props)
UI Components (Client/Server)
  ↓ (render)
HTML to User
```

**Type Safety**:
- TypeScript interfaces in `lib/types.ts`
- PayloadCMSDataService returns typed data
- Components receive typed props
- Build-time type checking

**No Breaking Changes**:
- Existing components continue to work
- Data shape maintained (Vendor, Product, etc.)
- Transform functions ensure compatibility
- Enhanced fields are additive (backward compatible)

## Compatibility Requirements

### Backward Compatibility

**With TinaCMS Schema**:
- All existing TinaCMS fields preserved in Payload
- Data structures maintained (arrays, objects, relationships)
- Field names unchanged where possible
- Relationship patterns consistent

**With Existing Frontend**:
- PayloadCMSDataService mimics TinaCMSDataService interface
- Same method signatures
- Same return types
- Drop-in replacement capability

**Migration Path**:
1. Both services can coexist during migration
2. Gradual page-by-page migration possible
3. Rollback to TinaCMS possible if needed
4. No forced breaking changes

### Version Compatibility Matrix

| Component | Version | Compatibility |
|-----------|---------|---------------|
| Next.js | 14.2.5 | ✅ Required |
| Payload CMS | 3.0+ | ✅ Required |
| PostgreSQL | 17+ | ✅ Recommended |
| SQLite | 3+ | ✅ Development only |
| Node.js | 22 LTS | ✅ Required |
| TypeScript | 5.2+ | ✅ Required |

## Deprecation Strategy

### TinaCMS Deprecation

**Phase 1**: Migration (This Spec)
- Payload CMS fully implemented
- All data migrated to Payload
- Frontend uses Payload exclusively
- TinaCMS files remain (reference only)

**Phase 2**: Cleanup (Post-Migration)
- TinaCMS dependencies can be removed
- TinaCMSDataService marked deprecated
- Migration scripts archived
- Documentation updated

**Timeline**:
- Keep TinaCMS for 30 days post-migration (safety)
- Remove TinaCMS dependencies after verification period
- Archive TinaCMS files for historical reference

### Migration Support

**Support Period**: 30 days post-production deployment

**Rollback Capability**:
- TinaCMS markdown files preserved
- TinaCMSDataService available for rollback
- Database backup for quick restore
- Frontend can be reverted if critical issues

## Integration Testing

### API Integration Tests

**Test Payload API Directly**:
```typescript
describe('Payload API Integration', () => {
  test('GET /api/vendors returns vendors', async () => {
    const response = await fetch('http://localhost:3000/api/vendors');
    expect(response.status).toBe(200);
    const data = await response.json();
    expect(data.docs).toBeDefined();
    expect(Array.isArray(data.docs)).toBe(true);
  });

  test('GET /api/vendors/:id with depth=2 includes relationships', async () => {
    const response = await fetch('http://localhost:3000/api/vendors/1?depth=2');
    const data = await response.json();
    expect(data.category).toBeDefined();
    expect(typeof data.category).toBe('object'); // Populated, not just ID
  });
});
```

### Database Integration Tests

**Test Data Persistence**:
```typescript
describe('Database Integration', () => {
  test('Vendor data persists across requests', async () => {
    // Create vendor
    const vendor = await payload.create({
      collection: 'vendors',
      data: { companyName: 'Test Co', slug: 'test-co' }
    });

    // Fetch vendor
    const fetched = await payload.findByID({
      collection: 'vendors',
      id: vendor.id
    });

    expect(fetched.companyName).toBe('Test Co');
  });
});
```

### Frontend Integration Tests

**Test Pages with Payload Data**:
```typescript
describe('Frontend Payload Integration', () => {
  test('Vendor page builds with Payload data', async () => {
    const vendors = await payloadCMSDataService.getAllVendors();
    expect(vendors.length).toBeGreaterThan(0);

    const vendor = vendors[0];
    expect(vendor.companyName).toBeDefined();
    expect(vendor.slug).toBeDefined();
  });
});
```

## Production Deployment Integration

### Hosting Platform Integration

**Vercel/Netlify Deployment**:
- Environment variables configured
- Build command: `npm run build`
- PostgreSQL connection from environment
- Static export to CDN

**Database Hosting**:
- Managed PostgreSQL (AWS RDS, DigitalOcean, Supabase)
- Connection pooling configured
- Automatic backups enabled
- Read replicas for scaling (optional)

**Monitoring Integration**:
- Error tracking (Sentry)
- Performance monitoring (Vercel Analytics)
- Database monitoring (PostgreSQL metrics)
- API response time tracking

## Success Criteria

- [ ] All Payload API endpoints functional
- [ ] PayloadCMSDataService fully integrated
- [ ] Database connections stable (< 1% error rate)
- [ ] All frontend pages use Payload data
- [ ] No TinaCMS dependencies in production build
- [ ] API response times < 500ms (cached)
- [ ] Build succeeds with Payload data source
- [ ] Zero data loss during migration
- [ ] All relationships intact
- [ ] Monitoring and error tracking configured
