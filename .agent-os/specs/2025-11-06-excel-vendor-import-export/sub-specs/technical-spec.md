# Technical Specification: Excel Vendor Import/Export

This is the technical specification for the spec detailed in @.agent-os/specs/2025-11-06-excel-vendor-import-export/spec.md

## Architecture Overview

### System Components

```
┌─────────────────────────────────────────────────────────────────┐
│                       Frontend (Vendor Portal)                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐│
│  │ Download Template│  │  Upload Excel    │  │  Export Data   ││
│  │     Button       │  │   Drag & Drop    │  │     Button     ││
│  └──────────────────┘  └──────────────────┘  └────────────────┘│
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API Routes (Next.js)                        │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐│
│  │ GET /template    │  │ POST /import     │  │ GET /export    ││
│  │                  │  │                  │  │                ││
│  └──────────────────┘  └──────────────────┘  └────────────────┘│
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Service Layer                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐│
│  │ ExcelTemplate    │  │  ExcelParser     │  │ ExcelExport    ││
│  │    Service       │  │    Service       │  │   Service      ││
│  └──────────────────┘  └──────────────────┘  └────────────────┘│
│  ┌──────────────────┐  ┌──────────────────┐                    │
│  │   Validation     │  │   Import         │                    │
│  │    Service       │  │  Execution       │                    │
│  └──────────────────┘  └──────────────────┘                    │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Data Layer                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐│
│  │  Payload CMS     │  │  Tier Access     │  │  Field Config  ││
│  │   Collections    │  │    Control       │  │    Mapping     ││
│  └──────────────────┘  └──────────────────┘  └────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## Tier-to-Field Mapping Configuration

### Configuration File Structure

**File**: `lib/config/excel-field-mappings.ts`

```typescript
export interface FieldMapping {
  // Field identification
  payloadField: string;           // Payload CMS field name
  excelColumn: string;            // Excel column header
  sheet: 'company' | 'products' | 'locations';

  // Tier access control
  minTier: 'free' | 'tier1' | 'tier2' | 'tier3';

  // Field metadata
  fieldType: 'text' | 'number' | 'boolean' | 'date' | 'email' | 'url' | 'richText' | 'array' | 'relationship';
  required: boolean;
  maxLength?: number;

  // Validation rules
  validation?: {
    min?: number;
    max?: number;
    pattern?: RegExp;
    enum?: string[];
  };

  // Excel-specific config
  excelConfig: {
    width?: number;              // Column width in characters
    dataValidation?: {           // Dropdown lists
      type: 'list';
      values: string[];
    };
    format?: string;             // Excel number/date format
    description?: string;        // Help text for column
    example?: string;            // Example value
  };

  // Array/relationship handling
  arrayConfig?: {
    separator: string;           // e.g., ", " or ";"
    subFields?: FieldMapping[];  // For nested objects in arrays
  };

  // Special handling flags
  adminOnly?: boolean;
  readOnly?: boolean;
  autoGenerated?: boolean;       // e.g., slug, timestamps
}

export interface SheetConfig {
  name: string;
  displayName: string;
  rowLimit: number;
  fields: FieldMapping[];
}

export const EXCEL_FIELD_MAPPINGS: Record<string, SheetConfig> = {
  company: {
    name: 'company',
    displayName: 'Company Information',
    rowLimit: 1,  // Only one vendor per file
    fields: [
      // FREE TIER FIELDS
      {
        payloadField: 'companyName',
        excelColumn: 'Company Name',
        sheet: 'company',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 255,
        excelConfig: {
          width: 30,
          description: 'Your company or organization name',
          example: 'Acme Marine Systems',
        },
      },
      {
        payloadField: 'description',
        excelColumn: 'Description',
        sheet: 'company',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 5000,
        excelConfig: {
          width: 50,
          description: 'Brief company description (max 5000 chars)',
          example: 'Leading provider of marine navigation systems...',
        },
      },
      {
        payloadField: 'contactEmail',
        excelColumn: 'Contact Email',
        sheet: 'company',
        minTier: 'free',
        fieldType: 'email',
        required: true,
        maxLength: 255,
        validation: {
          pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        },
        excelConfig: {
          width: 30,
          description: 'Primary contact email address',
          example: 'contact@acmemarine.com',
        },
      },
      {
        payloadField: 'contactPhone',
        excelColumn: 'Contact Phone',
        sheet: 'company',
        minTier: 'free',
        fieldType: 'text',
        required: false,
        maxLength: 50,
        excelConfig: {
          width: 20,
          description: 'Phone number with country code',
          example: '+1-555-123-4567',
        },
      },
      {
        payloadField: 'logo',
        excelColumn: 'Logo URL',
        sheet: 'company',
        minTier: 'free',
        fieldType: 'url',
        required: false,
        excelConfig: {
          width: 60,
          description: 'Public URL to company logo image (JPG, PNG, max 2MB)',
          example: 'https://example.com/images/logo.png',
        },
      },

      // TIER 1+ FIELDS
      {
        payloadField: 'website',
        excelColumn: 'Website',
        sheet: 'company',
        minTier: 'tier1',
        fieldType: 'url',
        required: false,
        maxLength: 500,
        excelConfig: {
          width: 40,
          description: 'Company website URL',
          example: 'https://www.acmemarine.com',
        },
      },
      {
        payloadField: 'foundedYear',
        excelColumn: 'Founded Year',
        sheet: 'company',
        minTier: 'tier1',
        fieldType: 'number',
        required: false,
        validation: {
          min: 1800,
          max: new Date().getFullYear(),
        },
        excelConfig: {
          width: 15,
          format: '0',
          description: 'Year company was founded',
          example: '2010',
        },
      },
      {
        payloadField: 'linkedinUrl',
        excelColumn: 'LinkedIn URL',
        sheet: 'company',
        minTier: 'tier1',
        fieldType: 'url',
        required: false,
        maxLength: 500,
        excelConfig: {
          width: 50,
          description: 'LinkedIn company page URL',
          example: 'https://www.linkedin.com/company/acme-marine',
        },
      },
      {
        payloadField: 'employeeCount',
        excelColumn: 'Number of Employees',
        sheet: 'company',
        minTier: 'tier1',
        fieldType: 'number',
        required: false,
        validation: {
          min: 0,
        },
        excelConfig: {
          width: 20,
          format: '0',
          description: 'Approximate number of employees',
          example: '50',
        },
      },

      // TIER 2+ FIELDS
      {
        payloadField: 'longDescription',
        excelColumn: 'Long Description (HTML)',
        sheet: 'company',
        minTier: 'tier2',
        fieldType: 'richText',
        required: false,
        excelConfig: {
          width: 80,
          description: 'Extended company description with HTML formatting',
          example: '<p>Acme Marine Systems has been...</p>',
        },
      },
      {
        payloadField: 'yearsInBusiness',
        excelColumn: 'Years in Business',
        sheet: 'company',
        minTier: 'tier2',
        fieldType: 'number',
        required: false,
        validation: {
          min: 0,
          max: 200,
        },
        excelConfig: {
          width: 20,
          format: '0',
          description: 'Number of years in business',
          example: '15',
        },
      },
      {
        payloadField: 'certifications',
        excelColumn: 'Certifications (JSON array)',
        sheet: 'company',
        minTier: 'tier2',
        fieldType: 'array',
        required: false,
        arrayConfig: {
          separator: '\n---\n',
          subFields: [
            {
              payloadField: 'name',
              excelColumn: 'name',
              sheet: 'company',
              minTier: 'tier2',
              fieldType: 'text',
              required: true,
              excelConfig: { width: 30 },
            },
            {
              payloadField: 'issuer',
              excelColumn: 'issuer',
              sheet: 'company',
              minTier: 'tier2',
              fieldType: 'text',
              required: true,
              excelConfig: { width: 30 },
            },
            {
              payloadField: 'year',
              excelColumn: 'year',
              sheet: 'company',
              minTier: 'tier2',
              fieldType: 'number',
              required: true,
              excelConfig: { width: 10 },
            },
          ],
        },
        excelConfig: {
          width: 100,
          description: 'JSON array of certifications: [{"name":"ISO 9001","issuer":"ISO","year":2020}]',
          example: '[{"name":"ISO 9001","issuer":"ISO","year":2020}]',
        },
      },
    ],
  },

  products: {
    name: 'products',
    displayName: 'Products',
    rowLimit: 999,  // Per-tier limits enforced separately
    fields: [
      {
        payloadField: 'name',
        excelColumn: 'Product Name',
        sheet: 'products',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 255,
        excelConfig: {
          width: 30,
          description: 'Product name',
          example: 'NavPro 3000 GPS System',
        },
      },
      {
        payloadField: 'shortDescription',
        excelColumn: 'Short Description',
        sheet: 'products',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 500,
        excelConfig: {
          width: 50,
          description: 'Brief product description (max 500 chars)',
          example: 'Advanced marine GPS navigation system...',
        },
      },
      {
        payloadField: 'categories',
        excelColumn: 'Categories',
        sheet: 'products',
        minTier: 'free',
        fieldType: 'relationship',
        required: false,
        arrayConfig: {
          separator: ', ',
        },
        excelConfig: {
          width: 40,
          description: 'Comma-separated category names',
          example: 'Navigation, Electronics',
        },
      },
      {
        payloadField: 'price',
        excelColumn: 'Price',
        sheet: 'products',
        minTier: 'free',
        fieldType: 'text',
        required: false,
        maxLength: 100,
        excelConfig: {
          width: 20,
          description: 'Price display text (e.g., "$1,999" or "Contact for pricing")',
          example: '$1,999.99',
        },
      },
      {
        payloadField: 'images',
        excelColumn: 'Image URLs',
        sheet: 'products',
        minTier: 'free',
        fieldType: 'array',
        required: false,
        arrayConfig: {
          separator: '\n',
        },
        excelConfig: {
          width: 80,
          description: 'Image URLs, one per line (max per tier: Free=1, Tier1=3, Tier2=10, Tier3=unlimited)',
          example: 'https://example.com/product1.jpg\nhttps://example.com/product2.jpg',
        },
      },
      {
        payloadField: 'features',
        excelColumn: 'Features (JSON array)',
        sheet: 'products',
        minTier: 'tier1',
        fieldType: 'array',
        required: false,
        excelConfig: {
          width: 100,
          description: 'JSON array of features: [{"title":"Waterproof","description":"IP67 rated"}]',
          example: '[{"title":"Waterproof","description":"IP67 rated"}]',
        },
      },
      {
        payloadField: 'specifications',
        excelColumn: 'Specifications (JSON array)',
        sheet: 'products',
        minTier: 'tier1',
        fieldType: 'array',
        required: false,
        excelConfig: {
          width: 100,
          description: 'JSON array of specs: [{"label":"Dimensions","value":"10x8x3 inches"}]',
          example: '[{"label":"Dimensions","value":"10x8x3 inches"}]',
        },
      },
    ],
  },

  locations: {
    name: 'locations',
    displayName: 'Locations',
    rowLimit: 999,  // Per-tier limits: free=1, tier1=3, tier2=10, tier3=999
    fields: [
      {
        payloadField: 'address',
        excelColumn: 'Address',
        sheet: 'locations',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 500,
        excelConfig: {
          width: 50,
          description: 'Full mailing address',
          example: '123 Harbor Drive, Suite 200',
        },
      },
      {
        payloadField: 'city',
        excelColumn: 'City',
        sheet: 'locations',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 255,
        excelConfig: {
          width: 25,
          description: 'City name',
          example: 'Miami',
        },
      },
      {
        payloadField: 'country',
        excelColumn: 'Country',
        sheet: 'locations',
        minTier: 'free',
        fieldType: 'text',
        required: true,
        maxLength: 255,
        excelConfig: {
          width: 25,
          description: 'Country name',
          example: 'United States',
        },
      },
      {
        payloadField: 'latitude',
        excelColumn: 'Latitude',
        sheet: 'locations',
        minTier: 'free',
        fieldType: 'number',
        required: false,
        validation: {
          min: -90,
          max: 90,
        },
        excelConfig: {
          width: 15,
          format: '0.000000',
          description: 'Latitude coordinate (-90 to 90)',
          example: '25.7617',
        },
      },
      {
        payloadField: 'longitude',
        excelColumn: 'Longitude',
        sheet: 'locations',
        minTier: 'free',
        fieldType: 'number',
        required: false,
        validation: {
          min: -180,
          max: 180,
        },
        excelConfig: {
          width: 15,
          format: '0.000000',
          description: 'Longitude coordinate (-180 to 180)',
          example: '-80.1918',
        },
      },
      {
        payloadField: 'isHQ',
        excelColumn: 'Is Headquarters',
        sheet: 'locations',
        minTier: 'free',
        fieldType: 'boolean',
        required: false,
        excelConfig: {
          width: 20,
          dataValidation: {
            type: 'list',
            values: ['Yes', 'No', 'TRUE', 'FALSE', '1', '0'],
          },
          description: 'Is this your headquarters? (Yes/No) - Exactly one location must be HQ',
          example: 'Yes',
        },
      },
    ],
  },
};
```

## API Endpoints

### GET `/api/portal/vendors/[id]/excel-template`

**Purpose**: Download Excel template for vendor's current tier

**Request**:
```typescript
GET /api/portal/vendors/123/excel-template
Headers:
  Authorization: Bearer <session_token>
```

**Response**:
```typescript
HTTP 200 OK
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="vendor-template-tier2-2025-11-06.xlsx"

<Excel file binary data>
```

**Implementation** (`app/api/portal/vendors/[id]/excel-template/route.ts`):
```typescript
import { getPayload } from 'payload';
import { ExcelTemplateService } from '@/lib/services/ExcelTemplateService';

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  // 1. Authenticate user
  const payload = await getPayload({ config });
  const user = await payload.auth({ headers: request.headers });

  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. Verify vendor ownership
  const vendor = await payload.findByID({
    collection: 'vendors',
    id: params.id,
  });

  if (vendor.user !== user.id && user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  // 3. Generate template for vendor's tier
  const templateService = new ExcelTemplateService();
  const workbook = await templateService.generateTemplate(vendor.tier);

  // 4. Stream to response
  const buffer = await workbook.xlsx.writeBuffer();
  const filename = `vendor-template-${vendor.tier}-${new Date().toISOString().split('T')[0]}.xlsx`;

  return new NextResponse(buffer, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'Content-Disposition': `attachment; filename="${filename}"`,
    },
  });
}
```

### POST `/api/portal/vendors/[id]/excel-import`

**Purpose**: Upload and import Excel file

**Request**:
```typescript
POST /api/portal/vendors/123/excel-import
Content-Type: multipart/form-data
Headers:
  Authorization: Bearer <session_token>

Body:
  file: <Excel file>
  preview: "true" | "false"  // Optional: if true, return preview without importing
```

**Response (Preview Mode)**:
```typescript
HTTP 200 OK
Content-Type: application/json

{
  "preview": true,
  "valid": true,
  "company": {
    "action": "update",  // "create" | "update" | "no_change"
    "existing": { ... },
    "proposed": { ... },
    "changes": {
      "description": { old: "...", new: "..." },
      "website": { old: null, new: "https://..." }
    }
  },
  "products": {
    "create": [
      { name: "Product A", ... },
      { name: "Product B", ... }
    ],
    "update": [
      { id: "prod_123", name: "Product C", changes: {...} }
    ],
    "total": 5
  },
  "locations": {
    "create": [
      { city: "New York", isHQ: true }
    ],
    "total": 1
  },
  "validation": {
    "errors": [],
    "warnings": [
      { sheet: "products", row: 3, column: "Image URLs", message: "Image 2 URL returned 404" }
    ]
  }
}
```

**Response (Import Mode)**:
```typescript
HTTP 200 OK
Content-Type: application/json

{
  "success": true,
  "vendor": { id: "123", slug: "acme-marine" },
  "stats": {
    "products": { created: 3, updated: 2 },
    "locations": { created: 1, updated: 0 }
  },
  "importId": "import_abc123",
  "timestamp": "2025-11-06T12:34:56Z"
}
```

**Error Response**:
```typescript
HTTP 400 Bad Request
Content-Type: application/json

{
  "error": "Validation failed",
  "valid": false,
  "validation": {
    "errors": [
      {
        "sheet": "company",
        "row": 1,
        "column": "Contact Email",
        "field": "contactEmail",
        "value": "invalid-email",
        "message": "Invalid email format"
      },
      {
        "sheet": "products",
        "row": 3,
        "column": "Product Name",
        "field": "name",
        "value": "",
        "message": "Product name is required"
      },
      {
        "sheet": "locations",
        "row": 2,
        "column": "Is Headquarters",
        "field": "isHQ",
        "value": "Yes",
        "message": "Only one location can be headquarters (row 1 is already HQ)"
      }
    ],
    "warnings": []
  }
}
```

## Service Implementation

### ExcelTemplateService

**File**: `lib/services/ExcelTemplateService.ts`

```typescript
import ExcelJS from 'exceljs';
import { EXCEL_FIELD_MAPPINGS, TIER_HIERARCHY } from '@/lib/config/excel-field-mappings';

export class ExcelTemplateService {
  async generateTemplate(tier: 'free' | 'tier1' | 'tier2' | 'tier3'): Promise<ExcelJS.Workbook> {
    const workbook = new ExcelJS.Workbook();

    // Add instructions sheet first
    this.addInstructionsSheet(workbook, tier);

    // Add data sheets (company, products, locations)
    for (const [sheetKey, sheetConfig] of Object.entries(EXCEL_FIELD_MAPPINGS)) {
      this.addDataSheet(workbook, sheetConfig, tier);
    }

    return workbook;
  }

  private addInstructionsSheet(workbook: ExcelJS.Workbook, tier: string): void {
    const sheet = workbook.addWorksheet('Instructions', {
      properties: { tabColor: { argb: 'FF4472C4' } }
    });

    // Add instructions content
    sheet.getCell('A1').value = 'Excel Import Template Instructions';
    sheet.getCell('A1').font = { size: 18, bold: true };

    sheet.getCell('A3').value = `This template is configured for: ${tier.toUpperCase()}`;
    sheet.getCell('A3').font = { size: 14, bold: true, color: { argb: 'FF0070C0' } };

    // Add detailed instructions...
    const instructions = [
      '',
      'How to Use This Template:',
      '1. Fill in the "Company Information" sheet with your company details',
      '2. Add products in the "Products" sheet (one product per row)',
      '3. Add locations in the "Locations" sheet (one location per row)',
      '4. Save the file and upload it through your vendor portal',
      '',
      'Important Notes:',
      '- Fields marked with * are required',
      '- Some fields are only available for higher tiers (shown in column headers)',
      '- Do not modify column headers or sheet names',
      '- For array fields (JSON), use the exact format shown in examples',
      '- Image URLs must be publicly accessible',
      '- Exactly one location must be marked as "Headquarters"',
      '',
      `Tier Limits (${tier}):`,
      `- Products: ${this.getProductLimit(tier)}`,
      `- Images per product: ${this.getImageLimit(tier)}`,
      `- Locations: ${this.getLocationLimit(tier)}`,
    ];

    instructions.forEach((line, index) => {
      sheet.getCell(`A${5 + index}`).value = line;
    });

    sheet.getColumn('A').width = 100;
  }

  private addDataSheet(
    workbook: ExcelJS.Workbook,
    sheetConfig: SheetConfig,
    tier: string
  ): void {
    const sheet = workbook.addWorksheet(sheetConfig.displayName);

    // Filter fields for current tier
    const tierLevel = TIER_HIERARCHY[tier];
    const accessibleFields = sheetConfig.fields.filter(
      field => TIER_HIERARCHY[field.minTier] <= tierLevel
    );

    // Add headers
    const headers = accessibleFields.map(field => field.excelColumn);
    sheet.addRow(headers);

    // Style header row
    const headerRow = sheet.getRow(1);
    headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
    headerRow.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FF4472C4' }
    };
    headerRow.height = 20;

    // Add descriptions as row 2 (comment row)
    const descriptions = accessibleFields.map(field =>
      field.excelConfig.description || ''
    );
    sheet.addRow(descriptions);
    sheet.getRow(2).font = { italic: true, size: 9, color: { argb: 'FF666666' } };

    // Add example data as row 3
    const examples = accessibleFields.map(field =>
      field.excelConfig.example || ''
    );
    sheet.addRow(examples);
    sheet.getRow(3).font = { italic: true, color: { argb: 'FF999999' } };

    // Configure columns
    accessibleFields.forEach((field, index) => {
      const column = sheet.getColumn(index + 1);
      column.width = field.excelConfig.width || 20;

      // Add data validation for dropdowns
      if (field.excelConfig.dataValidation) {
        for (let row = 4; row <= 1000; row++) {
          sheet.getCell(row, index + 1).dataValidation = {
            type: 'list',
            allowBlank: !field.required,
            formulae: [`"${field.excelConfig.dataValidation.values.join(',')}"`],
            showErrorMessage: true,
            errorTitle: 'Invalid Value',
            error: `Please select from the dropdown list`,
          };
        }
      }

      // Add number formatting
      if (field.excelConfig.format) {
        column.numFmt = field.excelConfig.format;
      }
    });

    // Freeze header rows
    sheet.views = [{ state: 'frozen', xSplit: 0, ySplit: 3 }];
  }

  private getProductLimit(tier: string): string {
    const limits = { free: 1, tier1: 5, tier2: 25, tier3: 'Unlimited' };
    return limits[tier] || 'Unknown';
  }

  private getImageLimit(tier: string): string {
    const limits = { free: 1, tier1: 3, tier2: 10, tier3: 'Unlimited' };
    return limits[tier] || 'Unknown';
  }

  private getLocationLimit(tier: string): string {
    const limits = { free: 1, tier1: 3, tier2: 10, tier3: 10 };
    return limits[tier].toString() || 'Unknown';
  }
}
```

### ExcelParserService

**File**: `lib/services/ExcelParserService.ts`

```typescript
import ExcelJS from 'exceljs';
import { EXCEL_FIELD_MAPPINGS } from '@/lib/config/excel-field-mappings';

export interface ParsedExcelData {
  company: Record<string, any>;
  products: Array<Record<string, any>>;
  locations: Array<Record<string, any>>;
}

export class ExcelParserService {
  async parseFile(filePath: string): Promise<ParsedExcelData> {
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.readFile(filePath);

    return {
      company: this.parseSheet(workbook, 'company'),
      products: this.parseSheet(workbook, 'products', true),
      locations: this.parseSheet(workbook, 'locations', true),
    };
  }

  private parseSheet(
    workbook: ExcelJS.Workbook,
    sheetKey: string,
    multiRow: boolean = false
  ): any {
    const sheetConfig = EXCEL_FIELD_MAPPINGS[sheetKey];
    const sheet = workbook.getWorksheet(sheetConfig.displayName);

    if (!sheet) {
      throw new Error(`Sheet "${sheetConfig.displayName}" not found`);
    }

    // Row 1: headers, Row 2: descriptions, Row 3: examples, Row 4+: data
    const headerRow = sheet.getRow(1);
    const headers: string[] = [];
    headerRow.eachCell((cell, colNumber) => {
      headers[colNumber - 1] = cell.text;
    });

    // Map headers to field configs
    const fieldMap = new Map<number, FieldMapping>();
    headers.forEach((header, index) => {
      const field = sheetConfig.fields.find(f => f.excelColumn === header);
      if (field) {
        fieldMap.set(index, field);
      }
    });

    // Parse data rows
    if (!multiRow) {
      // Single row (company info)
      const dataRow = sheet.getRow(4);
      return this.parseRow(dataRow, fieldMap);
    } else {
      // Multiple rows (products, locations)
      const results: any[] = [];
      sheet.eachRow((row, rowNumber) => {
        if (rowNumber <= 3) return; // Skip header rows

        const data = this.parseRow(row, fieldMap);

        // Skip empty rows
        if (Object.values(data).some(v => v !== null && v !== '')) {
          results.push(data);
        }
      });
      return results;
    }
  }

  private parseRow(row: ExcelJS.Row, fieldMap: Map<number, FieldMapping>): Record<string, any> {
    const data: Record<string, any> = {};

    row.eachCell((cell, colNumber) => {
      const field = fieldMap.get(colNumber - 1);
      if (!field) return;

      let value = cell.value;

      // Type conversions
      switch (field.fieldType) {
        case 'number':
          value = typeof value === 'number' ? value : parseFloat(value as string);
          break;
        case 'boolean':
          value = ['yes', 'true', '1', 1, true].includes(
            typeof value === 'string' ? value.toLowerCase() : value
          );
          break;
        case 'array':
          if (field.arrayConfig) {
            value = this.parseArray(value as string, field);
          }
          break;
        case 'richText':
          // Keep as string, will be processed later
          break;
      }

      data[field.payloadField] = value;
    });

    return data;
  }

  private parseArray(value: string, field: FieldMapping): any[] {
    if (!value || !field.arrayConfig) return [];

    const items = value.split(field.arrayConfig.separator);

    // Try parsing as JSON first
    try {
      return JSON.parse(value);
    } catch {
      // If not JSON, treat as simple array
      return items.map(item => item.trim()).filter(Boolean);
    }
  }
}
```

## Database Schema Considerations

### Import History Tracking

**New Collection**: `ImportHistory`

```typescript
// payload/collections/ImportHistory.ts
export const ImportHistory: CollectionConfig = {
  slug: 'import-history',
  admin: {
    useAsTitle: 'importId',
    defaultColumns: ['importId', 'vendor', 'status', 'createdAt'],
  },
  access: {
    read: ({ req: { user } }) => {
      if (user?.role === 'admin') return true;
      return { user: { equals: user?.id } };
    },
    create: ({ req: { user } }) => !!user,
    update: () => false,
    delete: ({ req: { user } }) => user?.role === 'admin',
  },
  fields: [
    {
      name: 'importId',
      type: 'text',
      required: true,
      unique: true,
    },
    {
      name: 'vendor',
      type: 'relationship',
      relationTo: 'vendors',
      required: true,
    },
    {
      name: 'user',
      type: 'relationship',
      relationTo: 'users',
      required: true,
    },
    {
      name: 'filename',
      type: 'text',
      required: true,
    },
    {
      name: 'status',
      type: 'select',
      required: true,
      options: [
        { label: 'Success', value: 'success' },
        { label: 'Failed', value: 'failed' },
        { label: 'Partial', value: 'partial' },
      ],
    },
    {
      name: 'stats',
      type: 'group',
      fields: [
        { name: 'productsCreated', type: 'number', defaultValue: 0 },
        { name: 'productsUpdated', type: 'number', defaultValue: 0 },
        { name: 'locationsCreated', type: 'number', defaultValue: 0 },
        { name: 'locationsUpdated', type: 'number', defaultValue: 0 },
      ],
    },
    {
      name: 'errors',
      type: 'array',
      fields: [
        { name: 'sheet', type: 'text' },
        { name: 'row', type: 'number' },
        { name: 'column', type: 'text' },
        { name: 'message', type: 'text' },
      ],
    },
  ],
  timestamps: true,
};
```

## Testing Strategy

### Unit Tests
- `ExcelTemplateService.test.ts` - Template generation for each tier
- `ExcelParserService.test.ts` - File parsing with valid/invalid data
- `ImportValidationService.test.ts` - Validation rules and tier restrictions
- `ExcelExportService.test.ts` - Export with existing data

### Integration Tests
- `excel-import-api.test.ts` - API endpoint testing
- `tier-field-filtering.test.ts` - Tier-based field access control
- `atomic-import.test.ts` - Transaction rollback on errors
- `data-persistence.test.ts` - Verify imported data persists correctly

### E2E Tests (Playwright)
- Template download flow
- File upload and validation errors
- Preview and import confirmation
- Export with pre-filled data
- Admin bulk import

## Performance Benchmarks

- **Template Generation**: <2 seconds for any tier
- **File Upload (10MB)**: <5 seconds
- **Parsing (100 products)**: <3 seconds
- **Validation (100 products)**: <10 seconds
- **Import (100 products)**: <30 seconds
- **Export (100 products)**: <5 seconds

## Future Optimizations

1. **Background Job Processing**: Queue large imports for async processing
2. **Streaming Parsing**: Handle files >10MB without loading fully into memory
3. **Parallel Validation**: Use worker threads for row validation
4. **Caching**: Cache field mappings and tier configurations
5. **Compression**: Gzip Excel files before download
