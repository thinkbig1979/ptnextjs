#!/bin/bash

# =============================================================================
# PTNEXTJS PRODUCTION UPGRADE SCRIPT (PostgreSQL Version)
# =============================================================================
#
# ARCHITECTURE OVERVIEW:
# ----------------------
# This deployment uses a split directory structure:
#
#   Git Repository:     /home/pt/ptnextjs
#   Docker Compose:     /home/dockge/stacks/ptnext-app
#   PostgreSQL Data:    /var/lib/ptnextjs/postgres (bind-mounted volume)
#   Media Files:        /home/dockge/stacks/ptnext-app/media
#
# The Docker Compose build context points to the git repository, while the
# compose configuration lives in Dockge's stacks directory. PostgreSQL data
# is stored on a bind-mounted volume, ensuring data persists independently of
# container lifecycle.
#
# ZERO-DOWNTIME DEPLOYMENT:
# -------------------------
# 1. Build new Docker image while old container runs
# 2. Swap containers (only seconds of downtime)
# 3. Entrypoint handles migrations automatically
#
# WHAT THIS SCRIPT DOES:
# ----------------------
# 1. Pulls latest code from git repository
# 2. Backs up PostgreSQL database (pg_dump)
# 3. Verifies required environment variables
# 4. Syncs media files from repo to compose directory
# 5. Builds new Docker image with NEXT_PUBLIC vars baked in
# 6. Swaps to new container (minimal downtime)
# 7. Cleans up old Docker images
# 8. Waits for health check
#
# USAGE:
# ------
#   ./upgrade.sh
#
# ROLLBACK:
# ---------
# If something goes wrong, restore the database backup:
#   gunzip -c /path/to/backups/payload-YYYYMMDD-HHMMSS.sql.gz | \
#     docker exec -i ptnextjs-postgres psql -U $POSTGRES_USER -d $POSTGRES_DB
#
# =============================================================================

set -e  # Exit on any error

# Define paths - CUSTOMIZE THESE FOR YOUR VPS
PROJECT_DIR="/home/pt/ptnextjs"
COMPOSE_DIR="/home/dockge/stacks/ptnext-app"
ENV_FILE=".env.production"
BACKUP_DIR="$COMPOSE_DIR/backups"

# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Starting update and redeploy process...${NC}"

# =============================================================================
# STEP 1: Pull latest code from git
# =============================================================================
echo -e "${YELLOW}Pulling latest changes from git...${NC}"
cd "$PROJECT_DIR" || { echo -e "${RED}Failed to cd to $PROJECT_DIR${NC}"; exit 1; }
git pull || { echo -e "${RED}Git pull failed${NC}"; exit 1; }
echo -e "${GREEN}Git pull completed${NC}"

# Change to compose directory for remaining operations
cd "$COMPOSE_DIR" || { echo -e "${RED}Failed to cd to $COMPOSE_DIR${NC}"; exit 1; }

# =============================================================================
# STEP 2: Load environment variables
# =============================================================================
echo -e "${YELLOW}Loading environment variables...${NC}"
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}Environment file $ENV_FILE not found${NC}"
    exit 1
fi
set -a
source "$ENV_FILE"
set +a
echo -e "${GREEN}Environment loaded${NC}"

# =============================================================================
# STEP 3: Backup PostgreSQL database
# =============================================================================
echo -e "${YELLOW}Backing up PostgreSQL database...${NC}"
mkdir -p "$BACKUP_DIR"

BACKUP_FILE="$BACKUP_DIR/payload-$(date +%Y%m%d-%H%M%S).sql.gz"

if docker exec ptnextjs-postgres pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" > /dev/null 2>&1; then
    docker exec ptnextjs-postgres pg_dump -U "$POSTGRES_USER" -d "$POSTGRES_DB" | gzip > "$BACKUP_FILE" || {
        echo -e "${RED}Database backup failed${NC}"; exit 1;
    }
    echo -e "${GREEN}Database backed up to: $BACKUP_FILE${NC}"

    # Keep only last 5 backups
    ls -t "$BACKUP_DIR"/payload-*.sql.gz 2>/dev/null | tail -n +6 | xargs -r rm --
    echo -e "${YELLOW}Old backups cleaned (keeping last 5)${NC}"
else
    echo -e "${YELLOW}PostgreSQL container not running - skipping backup${NC}"
    echo -e "${YELLOW}This is expected on first deployment${NC}"
fi

# =============================================================================
# STEP 4: Verify required environment variables
# =============================================================================
echo -e "${YELLOW}Verifying required environment variables...${NC}"
REQUIRED_VARS=(
    "NEXT_PUBLIC_SERVER_URL"
    "NEXT_PUBLIC_SITE_URL"
    "NEXT_PUBLIC_BASE_URL"
    "NEXT_PUBLIC_HCAPTCHA_SITE_KEY"
    "PAYLOAD_SECRET"
    "POSTGRES_USER"
    "POSTGRES_PASSWORD"
    "POSTGRES_DB"
    "DATABASE_URL"
)
MISSING_VARS=()
for var in "${REQUIRED_VARS[@]}"; do
    if [ -z "${!var}" ]; then
        MISSING_VARS+=("$var")
    fi
done
if [ ${#MISSING_VARS[@]} -ne 0 ]; then
    echo -e "${RED}Missing required variables: ${MISSING_VARS[*]}${NC}"
    exit 1
fi
echo -e "${GREEN}All required variables present${NC}"

# =============================================================================
# STEP 5: Sync media files
# =============================================================================
echo -e "${YELLOW}Syncing media files...${NC}"
MEDIA_TARGET="${MEDIA_PATH:-$COMPOSE_DIR/media}"
mkdir -p "$MEDIA_TARGET"
if [ -d "$PROJECT_DIR/public/media" ] && [ "$(ls -A $PROJECT_DIR/public/media 2>/dev/null)" ]; then
    cp -r "$PROJECT_DIR/public/media/"* "$MEDIA_TARGET/" 2>/dev/null || true
    echo -e "${GREEN}Media files synced to $MEDIA_TARGET${NC}"
else
    echo -e "${YELLOW}No media files to sync${NC}"
fi

# =============================================================================
# STEP 6: Build new Docker image
# =============================================================================
echo -e "${YELLOW}Building new image (old container still running)...${NC}"
echo -e "${YELLOW}This embeds NEXT_PUBLIC_* variables into the client bundle${NC}"

docker compose --env-file "$ENV_FILE" build --no-cache || {
    echo -e "${RED}Build failed${NC}"; exit 1;
}

echo -e "${GREEN}Image built successfully${NC}"

# =============================================================================
# STEP 7: Swap to new container
# =============================================================================
echo -e "${YELLOW}Swapping to new container...${NC}"
docker compose --env-file "$ENV_FILE" up -d --force-recreate app || {
    echo -e "${RED}Failed to start new container${NC}"; exit 1;
}

# =============================================================================
# STEP 8: Clean up old images
# =============================================================================
echo -e "${YELLOW}Cleaning up old images...${NC}"
docker image prune -f

# =============================================================================
# STEP 9: Wait for health check
# =============================================================================
echo -e "${YELLOW}Waiting for app to be healthy...${NC}"
APP_PORT="${PORT:-3000}"
for i in {1..60}; do
    if curl -sf "http://localhost:${APP_PORT}/api/health" > /dev/null 2>&1; then
        echo -e "${GREEN}App is healthy after ${i} seconds!${NC}"
        break
    fi
    if [ $i -eq 60 ]; then
        echo -e "${RED}App failed to become healthy in 60 seconds${NC}"
        echo -e "${YELLOW}Check logs with: docker compose --env-file $ENV_FILE logs app${NC}"
        exit 1
    fi
    sleep 1
done

# =============================================================================
# STEP 10: Verify NEXT_PUBLIC vars
# =============================================================================
echo -e "${YELLOW}Verifying NEXT_PUBLIC vars in client bundle...${NC}"
if docker exec ptnextjs-app sh -c 'grep -rq "hcaptcha" /app/.next/static/chunks/' 2>/dev/null; then
    echo -e "${GREEN}NEXT_PUBLIC vars successfully baked into client bundle${NC}"
else
    echo -e "${YELLOW}Note: Could not verify HCAPTCHA in bundle (may be in different chunk)${NC}"
fi

echo ""
echo -e "${GREEN}=======================================${NC}"
echo -e "${GREEN}Deployment completed successfully!${NC}"
echo -e "${GREEN}=======================================${NC}"
echo ""

# Show recent logs
echo -e "${YELLOW}Showing recent container logs (Ctrl+C to exit):${NC}"
docker compose --env-file "$ENV_FILE" logs -f --tail=50
