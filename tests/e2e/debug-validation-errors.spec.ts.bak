import { test, expect } from '@playwright/test';

const TEST_VENDOR = {
  email: 'testvendor@test.com',
  password: 'testpassword123',
};

// This test file is incomplete/broken and needs to be rewritten - skipping all tests
test.describe.skip('Debug Validation Errors', () => {
  test('should expose all validation errors in form', async ({ page }) => {
    // Enable console logging
    const consoleLogs: string[] = [];
    page.on('console', (msg) => {
      const text = msg.text();
      consoleLogs.push(text);
      console.log('Browser console:', text);
    });

    // Navigate to login
    await page.goto('http://localhost:3000/vendor/login');
    await page.waitForLoadState('networkidle');

    // Login
    await page.fill('input[type="email"]', TEST_VENDOR.email);
    await page.fill('input[type="password"]', TEST_VENDOR.password);
    await page.click('button[type="submit"]');

    // Wait for dashboard
    await page.waitForURL('**/vendor/dashboard**', { timeout: 10000 });
    await page.waitForLoadState('networkidle');

    // Navigate to profile tab
    await page.click('text=Profile');
    await page.waitForTimeout(2000);

    // Inject script to expose React Hook Form validation state
    const validationState = await page.evaluate(() => {
      // Find the form element
      const form = document.querySelector('form');
      if (!form) return { error: 'No form found' };

      // Get all inputs
      const inputs = Array.from(form.querySelectorAll('input, textarea')).map((el: any) => ({
        id: el.id,
        name: el.name || 'unnamed',
        value: el.value,
        disabled: el && (saveButton as any).disabled,
        required: el.required,
        type: el.type,
      }));

      // Check if button is disabled
      const submitButton = form.querySelector('button[type="submit"]');
      const buttonState = {
        exists: !!submitButton,
        disabled: (submitButton as any)?.disabled,
        text: submitButton?.textContent,
      };

      // Try to get form errors from DOM
      const errorMessages = Array.from(document.querySelectorAll('.text-red-500')).map(el => el.textContent);

      return {
        formExists: true,
        inputs,
        buttonState,
        errorMessages,
        formAction: form.action,
        formMethod: form.method,
      };
    });

    console.log('\n=== FORM STATE ===');
    console.log(JSON.stringify(validationState, null, 2));

    // Try to modify description and check validation
    await page.fill('textarea[id="description"]', 'Updated test description that is definitely long enough to pass validation');
    await page.waitForTimeout(1000);

    // Check if button is now enabled
    const buttonEnabledAfterEdit = await page.evaluate(() => {
      const button = document.querySelector('button[type="submit"]');
      return {
        disabled: (button as any)?.disabled,
        text: button?.textContent,
      };
    });

    console.log('\n=== BUTTON STATE AFTER EDIT ===');
    console.log(JSON.stringify(buttonEnabledAfterEdit, null, 2));

    // Get validation errors by checking React Hook Form's formState
    const reactHookFormState = await page.evaluate(() => {
      const form = document.querySelector('form');
      if (!form) return null;

      // Try to access React internals (this might not work due to production build)
      const reactPropsKey = Object.keys(form).find(key => key.startsWith('__react'));
      if (reactPropsKey) {
        return 'React internals found but not accessible in production';
      }

      // Alternative: trigger validation by trying to submit
      const button = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (button && !button && (saveButton as any).disabled) {
        // Click the button and see what happens
        button.click();
        return 'Button clicked - check console for errors';
      }

      return 'Button is disabled, cannot trigger validation';
    });

    console.log('\n=== REACT HOOK FORM STATE ===');
    console.log(reactHookFormState);

    // Wait to see if any console errors appear
    await page.waitForTimeout(2000);

    // Check for validation error messages in the DOM
    const validationErrors = await page.evaluate(() => {
      const errors = Array.from(document.querySelectorAll('.text-red-500'))
        .map(el => ({
          text: el.textContent,
          parent: el.parentElement?.tagName,
          nearbyInput: el.parentElement?.querySelector('input, textarea')?.id,
        }));
      return errors;
    });

    console.log('\n=== VALIDATION ERRORS IN DOM ===');
    console.log(JSON.stringify(validationErrors, null, 2));

    // Analyze console logs
    console.log('\n=== ALL CONSOLE LOGS ===');
    consoleLogs.forEach((log, i) => {
      console.log(`${i}: ${log}`);
    });

    // Look for specific patterns
    const validationRelatedLogs = consoleLogs.filter(log =>
      log.includes('validation') ||
      log.includes('error') ||
      log.includes('Error') ||
      log.includes('handleSubmit') ||
      log.includes('BasicInfoForm')
    );

    console.log('\n=== VALIDATION-RELATED LOGS ===');
    validationRelatedLogs.forEach(log => console.log(log));
  });
});
