# Email Validation Fix for Test Vendor Seeding

## Problem
The `/api/test/vendors/seed` endpoint is rejecting test vendor emails with the error:
```
'vendor_0_Free Tier Test Vendor': 'The following field is invalid: email'
```

## Root Cause
Payload CMS uses strict email validation for `type: 'email'` fields. The built-in validator rejects test domain emails like `@test.com` because many email validation libraries don't recognize `.test` as a valid TLD, even though it's RFC 2606 reserved for testing.

### Affected Fields
1. **Users Collection** - `email` field (authentication field, auto-generated by Payload auth)
2. **Vendors Collection** - `contactEmail` field (line 128-134 in `/payload/collections/Vendors.ts`)

## Solution: Add Custom Validation for Test Environments

### Fix 1: Vendors Collection - Add Custom Validate to contactEmail

**File:** `/home/edwin/development/ptnextjs/payload/collections/Vendors.ts`

**Location:** Line 128-134

**Current Code:**
```typescript
{
  name: 'contactEmail',
  type: 'email',
  required: true,
  admin: {
    description: 'Contact email address',
  },
},
```

**Fixed Code:**
```typescript
{
  name: 'contactEmail',
  type: 'email',
  required: true,
  admin: {
    description: 'Contact email address',
  },
  validate: (value) => {
    // Basic email format check
    if (!value || typeof value !== 'string') {
      return 'Email is required';
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
      return 'Must be a valid email address';
    }

    // In test/development, allow test domains
    const isTestEnv = process.env.NODE_ENV === 'test' || process.env.NODE_ENV === 'development';
    const testDomains = ['@test.com', '@example.com', '@localhost'];
    const isTestEmail = testDomains.some(domain => value.endsWith(domain));

    if (!isTestEnv && isTestEmail) {
      return 'Test email domains are not allowed in production';
    }

    return true; // Valid
  },
},
```

### Fix 2: Users Collection - Add beforeValidate Hook

**File:** `/home/edwin/development/ptnextjs/payload/collections/Users.ts`

**Location:** Line 142, in the `hooks` object

**Current Code:**
```typescript
  timestamps: true,
  hooks: {
    beforeChange: [
```

**Fixed Code:**
```typescript
  timestamps: true,
  hooks: {
    beforeValidate: [
      // Allow test domain emails in test/development environments
      async ({ data, operation }) => {
        // Only process if email is present
        if (!data?.email) {
          return data;
        }

        // Check if this is a test environment and test email
        const isTestEnv = process.env.NODE_ENV === 'test' || process.env.NODE_ENV === 'development';
        const testDomains = ['.test', '.example.com', '.localhost'];
        const isTestEmail = testDomains.some(domain => data.email.includes(domain));

        if (isTestEnv && isTestEmail) {
          // Log for debugging
          console.log(`[Users] Allowing test email domain: ${data.email}`);
        }

        // Note: This hook runs before validation but doesn't bypass Payload's built-in
        // email validation. The real fix is in the Vendors contactEmail field which
        // has a custom validate function.

        return data;
      },
    ],
    beforeChange: [
```

### Fix 3: Seed API - Add overrideAccess and Better Error Handling

**File:** `/home/edwin/development/ptnextjs/app/api/test/vendors/seed/route.ts`

**Location:** Lines 109-117 and 129-147

**Changes:**
1. Add `overrideAccess: true` to both `payload.create()` calls
2. Improve error handling to capture and report Payload validation errors

**User Creation (Line 109):**
```typescript
const createdUser = await payload.create({
  collection: 'users',
  data: {
    email: vendorData.email,
    password: vendorData.password,
    role: 'vendor',
    status: vendorData.status || 'approved',
  },
  overrideAccess: true, // Bypass access control for test seeding
});
```

**Vendor Creation (Line 129):**
```typescript
const createdVendor = await payload.create({
  collection: 'vendors',
  data: {
    user: createdUser.id,
    slug,
    companyName: vendorData.companyName,
    contactEmail: vendorData.email,
    tier: vendorData.tier || 'free',
    description: vendorData.description || '',
    contactPhone: vendorData.contactPhone,
    website: vendorData.website,
    featured: vendorData.featured || false,
    published: true,
    foundedYear: vendorData.foundedYear,
    totalProjects: vendorData.totalProjects,
    employeeCount: vendorData.employeeCount,
    locations: locations.length > 0 ? locations : undefined,
  },
  overrideAccess: true, // Bypass access control for test seeding
});
```

**Improved Error Handling (Lines 149-154):**
```typescript
} catch (vendorError) {
  // Enhanced error reporting for Payload validation errors
  let errorMessage = 'Unknown error';

  if (vendorError instanceof Error) {
    errorMessage = vendorError.message;

    // Check for Payload validation error structure
    if ('data' in vendorError && Array.isArray((vendorError as any).data)) {
      const validationErrors = (vendorError as any).data;
      errorMessage = validationErrors.map((err: any) =>
        `${err.field}: ${err.message}`
      ).join(', ');
    }
  }

  errors[`vendor_${i}_${vendorData.companyName}`] = errorMessage;
  console.error(`Failed to create vendor ${vendorData.companyName}:`, errorMessage, vendorError);
}
```

## Alternative: Quick Fix - Use Valid Test Domains

If you want a quicker fix without modifying Payload configuration, change all test emails from `@test.com` to `@example.com` in:

- `/home/edwin/development/ptnextjs/tests/e2e/global-setup.ts`
- Any other test files using `@test.com` emails

Example:
```typescript
// Before
email: 'testvendor-free@test.com'

// After
email: 'testvendor-free@example.com'
```

The `example.com` domain is RFC-reserved and universally recognized by email validators.

## Testing the Fix

After applying the fixes, test with:

```bash
# 1. Clear any existing test vendors
npm run test:e2e -- --grep "reset"

# 2. Run seed API test
curl -X POST http://localhost:3000/api/test/vendors/seed \
  -H "Content-Type: application/json" \
  -d '[{
    "companyName": "Test Vendor",
    "email": "test@test.com",
    "password": "TestPassword123!",
    "tier": "free",
    "status": "approved"
  }]'

# 3. Run E2E tests
npm run test:e2e
```

## Summary

**Primary Issue:** Payload CMS's built-in email validation rejects `@test.com` domain emails.

**Root Cause:** Strict email validation library doesn't recognize `.test` TLD as valid.

**Solution:** Add custom `validate` function to `contactEmail` field in Vendors collection that allows test domains in test/development environments.

**Additional Improvement:** Add `overrideAccess: true` to seed API for cleaner test data creation.

**Quick Alternative:** Use `@example.com` instead of `@test.com` for test emails (universally recognized as valid).
