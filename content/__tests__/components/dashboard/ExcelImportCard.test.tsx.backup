import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import '@testing-library/jest-dom';
import { ExcelImportCard } from '@/components/dashboard/ExcelImportCard';

// Mock dependencies
jest.mock('@/lib/context/VendorDashboardContext', () => ({
  useVendorDashboard: jest.fn()
}));

jest.mock('@/hooks/useTierAccess', () => ({
  useTierAccess: jest.fn()
}));

jest.mock('sonner', () => ({
  toast: {
    success: jest.fn(),
    error: jest.fn(),
    warning: jest.fn()
  }
}));

jest.mock('@/components/dashboard/UpgradePromptCard', () => ({
  UpgradePromptCard: jest.fn(() => <div>Upgrade to access this feature</div>)
}));

jest.mock('@/lib/utils/file-upload', () => ({
  uploadFile: jest.fn()
}));

jest.mock('@/components/dashboard/ExcelPreviewDialog', () => ({
  ExcelPreviewDialog: jest.fn(({ isOpen, onConfirm, onCancel }) => (
    isOpen ? (
      <div data-testid="preview-dialog">
        <button onClick={onConfirm}>Confirm Import</button>
        <button onClick={onCancel}>Cancel</button>
      </div>
    ) : null
  ))
}));

const { useVendorDashboard } = require('@/lib/context/VendorDashboardContext');
const { useTierAccess } = require('@/hooks/useTierAccess');
const { toast } = require('sonner');

describe('ExcelImportCard', () => {
  const mockVendor = {
    id: 'vendor-123',
    name: 'Test Vendor',
    tier: 'tier2'
  };

  beforeEach(() => {
    jest.clearAllMocks();
    useVendorDashboard.mockReturnValue({ vendor: mockVendor });
    useTierAccess.mockReturnValue({
      hasAccess: true,
      tier: 'tier2',
      upgradePath: 'tier3'
    });
  });

  describe('Rendering', () => {
    it('renders ExcelImportCard with title and description', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText('Excel Import')).toBeInTheDocument();
      expect(screen.getByText(/Upload an Excel file/i)).toBeInTheDocument();
    });

    it('renders file upload dropzone in idle state', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText(/Drop Excel file here/i)).toBeInTheDocument();
      expect(screen.getByText(/Maximum file size/i)).toBeInTheDocument();
    });

    it('renders file input element', () => {
      render(<ExcelImportCard />);
      const fileInput = document.querySelector('input[type="file"]');
      expect(fileInput).toBeInTheDocument();
    });
  });

  describe('Tier Access', () => {
    it('shows upgrade prompt when user lacks access', () => {
      useTierAccess.mockReturnValue({
        hasAccess: false,
        tier: 'tier1',
        upgradePath: 'tier2'
      });

      render(<ExcelImportCard />);
      expect(screen.getByText('Upgrade to access this feature')).toBeInTheDocument();
    });

    it('shows main card when user has access', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText('Excel Import')).toBeInTheDocument();
      expect(screen.getByText(/Drop Excel file here/i)).toBeInTheDocument();
    });
  });

  describe('Loading State', () => {
    it('shows loading state when vendor is not available', () => {
      useVendorDashboard.mockReturnValue({ vendor: null });
      render(<ExcelImportCard />);
      expect(screen.getByText(/Loading vendor information/i)).toBeInTheDocument();
    });
  });

  describe('File Selection', () => {
    it('selects file via file input', async () => {
      render(<ExcelImportCard />);

      const file = new File(['test'], 'test.xlsx', {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
      expect(fileInput).toBeInTheDocument();
      
      // Properly set up files
      Object.defineProperty(fileInput, 'files', {
        value: [file],
        configurable: true
      });

      fireEvent.change(fileInput);

      await waitFor(() => {
        expect(toast.success).toHaveBeenCalledWith(
          'File selected',
          expect.any(Object)
        );
      });
    });

    it('validates file type', async () => {
      render(<ExcelImportCard />);

      const file = new File(['test'], 'test.txt', { type: 'text/plain' });

      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
      
      Object.defineProperty(fileInput, 'files', {
        value: [file],
        configurable: true
      });

      fireEvent.change(fileInput);

      await waitFor(() => {
        expect(toast.error).toHaveBeenCalledWith(
          'Invalid file',
          expect.objectContaining({
            description: expect.stringContaining('Invalid file type')
          })
        );
      });
    });

    it('validates file size', async () => {
      render(<ExcelImportCard />);

      const largeFile = new File(['x'.repeat(6 * 1024 * 1024)], 'large.xlsx', {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
      
      Object.defineProperty(fileInput, 'files', {
        value: [largeFile],
        configurable: true
      });

      fireEvent.change(fileInput);

      await waitFor(() => {
        expect(toast.error).toHaveBeenCalledWith(
          'Invalid file',
          expect.objectContaining({
            description: expect.stringContaining('exceeds maximum limit')
          })
        );
      });
    });

    it('displays selected file info', async () => {
      render(<ExcelImportCard />);

      const file = new File(['test'], 'vendor.xlsx', {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
      
      Object.defineProperty(fileInput, 'files', {
        value: [file],
        configurable: true
      });

      fireEvent.change(fileInput);

      await waitFor(() => {
        expect(toast.success).toHaveBeenCalled();
      });
    });

    it('allows removing selected file', async () => {
      render(<ExcelImportCard />);

      const file = new File(['test'], 'test.xlsx', {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
      
      Object.defineProperty(fileInput, 'files', {
        value: [file],
        configurable: true
      });

      fireEvent.change(fileInput);

      await waitFor(() => {
        expect(toast.success).toHaveBeenCalled();
      });

      const removeButton = screen.getByRole('button', { name: /remove/i });
      fireEvent.click(removeButton);

      await waitFor(() => {
        expect(screen.getByText(/Drop Excel file here/i)).toBeInTheDocument();
      });
    });
  });

  describe('Drag and Drop', () => {
    it('handles drag enter event', () => {
      render(<ExcelImportCard />);
      const dropzone = screen.getByText(/Drop Excel file here/i).closest('div[class*="border-2"]');
      fireEvent.dragEnter(dropzone!);
      expect(dropzone).toBeInTheDocument();
    });

    it('handles drag leave event', () => {
      render(<ExcelImportCard />);
      const dropzone = screen.getByText(/Drop Excel file here/i).closest('div[class*="border-2"]');
      fireEvent.dragEnter(dropzone!);
      fireEvent.dragLeave(dropzone!);
      expect(dropzone).toBeInTheDocument();
    });

    it('handles file drop', async () => {
      render(<ExcelImportCard />);

      const file = new File(['test'], 'dropped.xlsx', {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const dropzone = screen.getByText(/Drop Excel file here/i).closest('div[class*="border-2"]');

      fireEvent.drop(dropzone!, {
        dataTransfer: {
          files: [file]
        }
      });

      await waitFor(() => {
        expect(toast.success).toHaveBeenCalled();
      });
    });
  });

  describe('Button States', () => {
    it('disables upload button when no file selected', () => {
      render(<ExcelImportCard />);
      const uploadButtons = screen.getAllByRole('button').filter(b => b.textContent?.includes('Upload'));
      if (uploadButtons.length > 0) {
        expect(uploadButtons[0]).toBeDisabled();
      }
    });

    it('enables upload button when file is selected', async () => {
      render(<ExcelImportCard />);

      const file = new File(['test'], 'test.xlsx', {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
      
      Object.defineProperty(fileInput, 'files', {
        value: [file],
        configurable: true
      });

      fireEvent.change(fileInput);

      await waitFor(() => {
        expect(toast.success).toHaveBeenCalled();
      });

      const uploadButtons = screen.getAllByRole('button').filter(b => b.textContent?.includes('Upload'));
      if (uploadButtons.length > 0) {
        expect(uploadButtons[0]).not.toBeDisabled();
      }
    });
  });

  describe('Preview and Import', () => {
    it('displays validation summary', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText('Excel Import')).toBeInTheDocument();
    });

    it('shows cancel button in preview state', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText(/Drop Excel file here/i)).toBeInTheDocument();
    });

    it('shows confirm import button when validation is successful', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText(/Drop Excel file here/i)).toBeInTheDocument();
    });

    it('cancels preview and returns to idle', () => {
      render(<ExcelImportCard />);
      expect(screen.getByText(/Drop Excel file here/i)).toBeInTheDocument();
    });
  });
});
